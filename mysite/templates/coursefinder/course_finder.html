{% extends 'base.html' %}
{% load static %}


{% block content %}
    <link rel="stylesheet" href="{% static 'coursefinder/style.css' %}?v=1763455540">

    <h1>UniMatch</h1>

    <!-- USER AUTH (PROFILE DROPDOWN ETC) -->
    {% if user.is_authenticated %}
        <div class="profile-dropdown">
            <img src="{% static 'images/pfp.svg' %}" alt="pfp" class="pfp-small">
            <div class="dropdown-content">
                <a href="{% url 'accounts:profile' %}" class="dropdown-link">
                    <img src="{% static 'images/profile.svg' %}" alt="" class="icon">
                    <span>Profile</span>
                </a>
                <hr>
                <form action="{% url 'accounts:logout' %}?next={% url 'coursefinder:guest_coursefinder' %}"
                      method="post" style="margin:0;padding:0;">
                    {% csrf_token %}
                    <button type="submit" class="dropdown-link" style="background:none;border:none;">
                        <img src="{% static 'images/logout.svg' %}" alt="" class="icon">
                        <span>Logout</span>
                    </button>
                </form>
            </div>
        </div>
        <a href="{% url 'accounts:saved_matches' %}" class="saved-btn">Saved<br>Matches</a>
        <a href="{% url 'coursefinder:resources' %}" class="resources-btn">Helpful<br>Resources</a>
    {% else %}
        <div class="guest-options">
            <a href="{% url 'accounts:login' %}" class="button">SIGN IN</a>
        </div>
    {% endif %}

    <div class="tab-switcher">
        <div class="tab-btns">
            <button class="tab-btn active" id="matchesTabBtn">Matches</button>
            <button class="tab-btn" id="searchTabBtn">Uni Search</button>
            <div class="slider-bg" id="sliderBg" style="left:8px;"></div>
        </div>
    </div>

    <!-- MATCHES TAB -->
    <div id="matchesTabContent" class="tab-content" style="display:block;">
        <form method="POST" action="{% url 'coursefinder:coursefinder' %}?tab=matches" id="matches-search-form"
              autocomplete="off"
              class="search-form">
            {% csrf_token %}
            <div class="search-bar-wrapper">
                <div class="search-input-row">
                    <input type="text" name="query" id="matches-search" placeholder="Say Something..."
                           autocomplete="off">
                    <button type="button" id="matches-filter-btn" class="filter-btn" aria-label="Filter">
                        <img src="{% static 'images/filter.svg' %}" alt="Filter">
                    </button>
                </div>
                <div id="matches-filter-dropdown" class="filter-dropdown">
                    <div class="filter-form">
                        <label class="filter-label">
                            Min. UCAS Points
                            <select name="ucas_range" class="filter-select">
                                <option value="">Any</option>
                                {% for points, label in ucas_options %}
                                    <option value="{{ points }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </label>
                        <label class="filter-label">
                            Course Type
                            <select name="course_type" class="filter-select">
                                <option value="">Any</option>
                                {% for course_type in course_types %}
                                    <option value="{{ course_type }}">{{ course_type }}</option>
                                {% endfor %}
                            </select>
                        </label>

                        <label class="filter-label">
                            Duration
                            <select name="duration" class="filter-select">
                                <option value="">Any</option>
                                {% for duration in durations %}
                                    <option value="{{ duration }}">{{ duration }}</option>
                                {% endfor %}
                            </select>
                        </label>

                        <label class="filter-label">
                            Mode
                            <select name="mode" class="filter-select">
                                <option value="">Any</option>
                                {% for mode in modes %}
                                    <option value="{{ mode }}">{{ mode }}</option>
                                {% endfor %}
                            </select>
                        </label>

                        <label class="filter-label">
                            Location
                            <select name="location" class="filter-select">
                                <option value="">Any</option>
                                {% for location in locations %}
                                    <option value="{{ location }}">{{ location }}</option>
                                {% endfor %}
                            </select>
                        </label>

                        <label class="filter-label" style="display: flex; align-items: center; gap: 6px;">
                            <input type="checkbox" name="only_grades">
                            Show only grade-based requirements
                        </label>

                        <label class="filter-label" style="display: flex; align-items: center; gap: 6px;">
                            <input type="checkbox" name="no_requirements">
                            Show only courses with no requirements
                        </label>

                        <div class="filter-actions">
                            <button type="button" class="filter-submit" id="matches-apply-filters">
                                Apply Filters
                            </button>
                            <button type="button" class="filter-clear" id="matches-clear-filters">
                                Clear Filters
                            </button>
                        </div>
                    </div>
                </div>


                <div id="matches-search-tips" class="search-tips">
                    <div class="tips-title">Tips:</div>
                    <ul>
                        <li>"I have AAA in Maths, Physics, Chemistry"</li>
                        <li>"ABB in Biology, Chemistry, Maths"</li>
                        <li>"A in Maths, B in Physics, dropped Chemistry"</li>
                        <li>"Maths: A, Physics: B, Chemistry: C"</li>
                        <li>"I want to study Medicine"</li>
                        <li>"Looking to apply for Psychology"</li>
                    </ul>
                </div>
            </div>
        </form>

        <!-- AJAX Results Table -->
        <div id="results-table">
            {% if parsed_input %}
                <p style="text-align:center; margin-top:30px; font-size:1.3rem; font-weight:700; color:#2D5289FF;">
                    {{ parsed_input }}
                </p>
            {% endif %}
            {% include "coursefinder/_results_table.html" %}
        </div>
    </div>



    <!-- UNI SEARCH TAB -->
    <div id="searchTabContent" class="tab-content" style="display:none;">
        <form method="POST" action="{% url 'coursefinder:coursefinder' %}?tab=search" id="search-search-form"
              autocomplete="off"
              class="search-form">
            {% csrf_token %}
            <div class="search-bar-wrapper">
                <div class="search-input-row">
                    <input type="text" name="query" id="search-search" placeholder="Search" autocomplete="off">
                    <button type="button" id="search-filter-btn" class="filter-btn" aria-label="Filter">
                        <img src="{% static 'images/filter.svg' %}" alt="Filter">
                    </button>
                </div>
                <div id="search-filter-dropdown" class="filter-dropdown">
                    <div class="filter-form">

                        <label class="filter-label">
                            Min. UCAS Points
                            <select name="ucas_range" class="filter-select">
                                <option value="">Any</option>
                                {% for points, label in ucas_options %}
                                    <option value="{{ points }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </label>

                        <label class="filter-label">
                            Course Type
                            <select name="course_type" class="filter-select">
                                <option value="">Any</option>
                                {% for course_type in course_types %}
                                    <option value="{{ course_type }}">{{ course_type }}</option>
                                {% endfor %}
                            </select>
                        </label>

                        <label class="filter-label">
                            Duration
                            <select name="duration" class="filter-select">
                                <option value="">Any</option>
                                {% for duration in durations %}
                                    <option value="{{ duration }}">{{ duration }}</option>
                                {% endfor %}
                            </select>
                        </label>

                        <label class="filter-label">
                            Mode
                            <select name="mode" class="filter-select">
                                <option value="">Any</option>
                                {% for mode in modes %}
                                    <option value="{{ mode }}">{{ mode }}</option>
                                {% endfor %}
                            </select>
                        </label>

                        <label class="filter-label">
                            Location
                            <select name="location" class="filter-select">
                                <option value="">Any</option>
                                {% for location in locations %}
                                    <option value="{{ location }}">{{ location }}</option>
                                {% endfor %}
                            </select>
                        </label>

                        <label class="filter-label" style="display: flex; align-items: center; gap: 6px;">
                            <input type="checkbox" name="only_grades">
                            Show only grade-based requirements
                        </label>

                        <label class="filter-label" style="display: flex; align-items: center; gap: 6px;">
                            <input type="checkbox" name="no_requirements">
                            Show only courses with no requirements
                        </label>

                        <div class="filter-actions">
                            <button type="button" class="filter-submit" id="search-apply-filters">
                                Apply Filters
                            </button>
                            <button type="button" class="filter-clear" id="search-clear-filters">
                                Clear Filters
                            </button>
                        </div>
                    </div>
                </div>

                <div id="search-search-tips" class="search-tips">
                    <div class="tips-title">Examples:</div>
                    <ul>
                        <li>"University of Manchester"</li>
                        <li>"London"</li>
                        <li>"Best unis for Law"</li>
                        <li>"Medicine"</li>
                    </ul>
                </div>
            </div>
        </form>

        <!-- AJAX Results for Uni Search -->
        <div id="search-results-table">
            {% if mode == 'search' %}
                {% if parsed_input %}
                    <p style="text-align:center; margin-top:30px; font-size:1.3rem; font-weight:700; color:#2D5289FF;">
                        {{ parsed_input }}
                    </p>
                {% endif %}
                {% include "coursefinder/_results_table.html" %}
            {% endif %}
        </div>
    </div>

    <div class="rotating-text">
        <span id="text"></span>
        <span id="highlight"></span>
    </div>

    <script>
        // Set up filter dropdown for matches tab
        // These flags stop the setup from running multiple times which would slow down the page
        var matchesFilterSetup = false;
        var searchFilterSetup = false;

        function setupMatchesFilter() {
            // if already set up then don't do it again
            if (matchesFilterSetup) return;

            var matchesFilterBtn = document.getElementById('matches-filter-btn');
            var matchesFilterDropdown = document.getElementById('matches-filter-dropdown');

            if (matchesFilterBtn && matchesFilterDropdown) {
                matchesFilterBtn.onclick = function (e) {
                    e.stopPropagation();
                    // toggle between showing and hiding the dropdown
                    matchesFilterDropdown.style.display = (matchesFilterDropdown.style.display === 'block') ? 'none' : 'block';
                };
                matchesFilterSetup = true;
            }
        }

        // Set up filter dropdown for search tab
        function setupSearchFilter() {
            // if already set up then don't do it again
            if (searchFilterSetup) return;

            var searchFilterBtn = document.getElementById('search-filter-btn');
            var searchFilterDropdown = document.getElementById('search-filter-dropdown');

            console.log('Setting up search filter...');
            console.log('Search filter button found:', searchFilterBtn ? 'YES' : 'NO');
            console.log('Search filter dropdown found:', searchFilterDropdown ? 'YES' : 'NO');

            if (searchFilterBtn && searchFilterDropdown) {
                searchFilterBtn.onclick = function (e) {
                    e.stopPropagation();
                    console.log('Search filter clicked!');
                    // toggle between showing and hiding the dropdown
                    searchFilterDropdown.style.display = (searchFilterDropdown.style.display === 'block') ? 'none' : 'block';
                };
                searchFilterSetup = true;
                console.log('Search filter setup complete');
            } else {
                console.log('Could not set up search filter - missing elements');
            }
        }

        // Run this code when the page loads
        document.addEventListener('DOMContentLoaded', function () {
            setupMatchesFilter();
            setupSearchFilter();

            // Set up a single click listener that closes dropdowns when you click outside them
            // This is better than having multiple listeners because it improves performance
            document.addEventListener('click', function (e) {
                var matchesFilterDropdown = document.getElementById('matches-filter-dropdown');
                var matchesFilterBtn = document.getElementById('matches-filter-btn');
                var searchFilterDropdown = document.getElementById('search-filter-dropdown');
                var searchFilterBtn = document.getElementById('search-filter-btn');

                // check if matches dropdown is open and user clicked outside it
                if (matchesFilterDropdown && matchesFilterDropdown.style.display === 'block' &&
                    !matchesFilterDropdown.contains(e.target) && e.target !== matchesFilterBtn) {
                    matchesFilterDropdown.style.display = 'none';
                }

                // check if search dropdown is open and user clicked outside it
                if (searchFilterDropdown && searchFilterDropdown.style.display === 'block' &&
                    !searchFilterDropdown.contains(e.target) && e.target !== searchFilterBtn) {
                    searchFilterDropdown.style.display = 'none';
                }
            });
        });
    </script>


    <script>
        // Handle tips popups for both forms
        function setupTips(inputId, tipsId, formId) {
            const input = document.getElementById(inputId);
            const tipsBox = document.getElementById(tipsId);
            if (!input || !tipsBox) return;
            input.addEventListener('focus', function () {
                tipsBox.style.opacity = '1';
                tipsBox.style.pointerEvents = 'auto';
            });
            input.addEventListener('blur', function () {
                setTimeout(() => {
                    tipsBox.style.opacity = '0';
                    tipsBox.style.pointerEvents = 'none';
                }, 120);
            });
            document.getElementById(formId).addEventListener('submit', function () {
                tipsBox.style.opacity = '0';
                tipsBox.style.pointerEvents = 'none';
            });
        }

        window.addEventListener('DOMContentLoaded', function () {
            setupTips('matches-search', 'matches-search-tips', 'matches-search-form');
            setupTips('search-search', 'search-search-tips', 'search-search-form');
            // Hide all tips by default
            var allTips = document.querySelectorAll('.search-tips');
            for (var i = 0; i < allTips.length; i++) {
                allTips[i].style.opacity = '0';
                allTips[i].style.pointerEvents = 'none';
            }
        });

        // Rotating Text
        const phrases = [
            "Find your perfect university course in seconds.",
            "Compare degrees from top UK universities.",
            "Personalised matches—no stress, no hassle.",
            "Struggling to choose? Let UniMatch help you decide.",
            "Discover courses tailored to your interests.",
            "No ads, no nonsense. Just pure course search.",
            "Track your favourites and save your shortlist.",
            "Access exclusive tips for your university application.",
            "Wanna go Russell Group? We’ll show you the way.",
            "Browse entry requirements, deadlines, and more.",
            "Your degree. Your future. Sorted.",
            "UniMatch: Your shortcut to the perfect uni.",
            "Curious about grades? See what you need—instantly.",
            "Courses for every vibe, every dream.",
            "Start your journey. Find your match today.",
        ];
        let index = 1;
        const textElement = document.getElementById("text");
        const highlightElement = document.getElementById("highlight");
        highlightElement.style.backgroundColor = "#878787";

        function showHighlight() {
            highlightElement.style.width = 200;
        }

        function rotateText() {
            textElement.style.opacity = 0;
            setTimeout(() => {
                textElement.textContent = phrases[index];
                textElement.style.opacity = 1;
                index = (index + 1) % phrases.length;
            }, 500);
        }

        textElement.textContent = phrases[0];
        setInterval(showHighlight, 1000);
        setInterval(rotateText, 4000);

        // Tabs Switcher (with fade for smoothness)
        const matchesTabBtn = document.getElementById('matchesTabBtn');
        const searchTabBtn = document.getElementById('searchTabBtn');
        const matchesTabContent = document.getElementById('matchesTabContent');
        const searchTabContent = document.getElementById('searchTabContent');
        const sliderBg = document.getElementById('sliderBg');

        function showTab(tab) {
            if (tab === 'matches') {
                // Separate title for coursefinder
                document.title = "Coursefinder"
                // update which tab button looks active
                matchesTabBtn.classList.add('active');
                searchTabBtn.classList.remove('active');
                sliderBg.style.left = '8px';
                // hide search tab and show matches tab
                searchTabContent.style.display = 'none';
                matchesTabContent.style.display = 'block';
                // this line forces the browser to recalculate the layout which makes the fade transition work properly
                matchesTabContent.offsetHeight;
                matchesTabContent.style.opacity = 1;
            } else {
                // Separate title for Uni Search tab
                document.title = "Uni Search"
                // update which tab button looks active
                searchTabBtn.classList.add('active');
                matchesTabBtn.classList.remove('active');
                sliderBg.style.left = '164px';
                // hide matches tab and show search tab
                matchesTabContent.style.display = 'none';
                searchTabContent.style.display = 'block';
                // this line forces the browser to recalculate the layout which makes the fade transition work properly
                searchTabContent.offsetHeight;
                searchTabContent.style.opacity = 1;
            }
        }

        matchesTabBtn.addEventListener('click', () => showTab('matches'));
        searchTabBtn.addEventListener('click', () => showTab('search'));

        // CSS transition for tab-content
        document.head.insertAdjacentHTML("beforeend",
            '<style>.tab-content { transition: opacity .18s; opacity: 1;}</style>'
        );
    </script>

    <script>
        window.addEventListener('DOMContentLoaded', function () {
            // Django passes mode as {{ mode|escapejs }}
            const mode = "{{ mode|escapejs }}";
            if (mode === 'search') {
                showTab('search');
            } else {
                showTab('matches');
            }
        });

    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Generic function to handle form submission with AJAX
            function setupFormAjax(formId, resultsId) {
                var form = document.getElementById(formId);
                if (!form) return;

                form.onsubmit = function (e) {
                    e.preventDefault();

                    // Get the form data
                    var formData = new FormData(form);

                    // Create AJAX request
                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', form.action, true);
                    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

                    xhr.onreadystatechange = function () {
                        if (xhr.readyState === 4 && xhr.status === 200) {
                            var response = JSON.parse(xhr.responseText);
                            document.getElementById(resultsId).innerHTML = response.table_html;
                            // Set up heart buttons after loading new content
                            setupHeartButtons();
                        }
                    };

                    xhr.send(formData);
                };
            }

            // Set up both forms using the same function
            setupFormAjax('matches-search-form', 'results-table');
            setupFormAjax('search-search-form', 'search-results-table');
        });

        // Function to set up heart button functionality
        function setupHeartButtons() {
            {% if user.is_authenticated %}
                console.log('Setting up heart buttons...');
                var heartBtns = document.querySelectorAll('.heart-btn');
                console.log('Found heart buttons:', heartBtns.length);

                // Add click handler to each button
                for (var i = 0; i < heartBtns.length; i++) {
                    var btn = heartBtns[i];

                    // Skip if already has listener attached
                    if (btn.getAttribute('data-listener-attached') === 'true') {
                        console.log('Button already has listener, skipping');
                        continue;
                    }

                    // Mark as having listener
                    btn.setAttribute('data-listener-attached', 'true');

                    // Create a new event listener function
                    btn.addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();

                        var isCurrentlySaved = this.classList.contains('active');
                        console.log('Heart button clicked! Currently saved:', isCurrentlySaved);

                        // Get all the course info from the button
                        var university = this.getAttribute('data-university');
                        var course = this.getAttribute('data-course');
                        var courseType = this.getAttribute('data-course_type');
                        var duration = this.getAttribute('data-duration');
                        var requirements = this.getAttribute('data-requirements');
                        var courseLink = this.getAttribute('data-course_link');

                        // Choose the right URL - save or unsave
                        var requestUrl;
                        if (isCurrentlySaved) {
                            requestUrl = "{% url 'accounts:unsave_match' %}";
                        } else {
                            requestUrl = "{% url 'accounts:save_match' %}";
                        }

                        // Create the request data
                        var requestData = JSON.stringify({
                            university: university,
                            course: course,
                            course_type: courseType,
                            duration: duration,
                            requirements: requirements,
                            course_link: courseLink
                        });

                        var currentButton = this;

                        // Send the request using simple XMLHttpRequest
                        var xhr = new XMLHttpRequest();
                        xhr.open('POST', requestUrl, true);
                        xhr.setRequestHeader('Content-Type', 'application/json');
                        xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));

                        xhr.onreadystatechange = function () {
                            if (xhr.readyState === 4) {
                                if (xhr.status === 200) {
                                    console.log('Save/unsave successful');
                                    // Toggle the active class after successful request
                                    if (isCurrentlySaved) {
                                        currentButton.classList.remove('active');
                                    } else {
                                        currentButton.classList.add('active');
                                    }
                                } else {
                                    console.log('Save failed with status:', xhr.status);
                                    console.log('Response:', xhr.responseText);
                                }
                            }
                        };

                        xhr.send(requestData);
                    });
                }
            {% else %}
                console.log('User is NOT authenticated - no heart buttons');
            {% endif %}
        }

        // Cookie helper function
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Update heart buttons to show correct saved state when returning to page
        function refreshHeartStates() {
            {% if user.is_authenticated %}
                var heartBtns = document.querySelectorAll('.heart-btn');
                console.log('Refreshing heart states for', heartBtns.length, 'buttons');

                // Check each heart button to see if its course is saved
                for (var i = 0; i < heartBtns.length; i++) {
                    var btn = heartBtns[i];

                    // Get the course information from the button
                    var university = btn.getAttribute('data-university');
                    var course = btn.getAttribute('data-course');
                    var courseType = btn.getAttribute('data-course_type');
                    var duration = btn.getAttribute('data-duration');
                    var requirements = btn.getAttribute('data-requirements');
                    var courseLink = btn.getAttribute('data-course_link');

                    // Make a request to check if this course is saved
                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', "{% url 'accounts:check_saved' %}", true);
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));

                    // Store reference to button for use in response handler
                    xhr.buttonElement = btn;

                    xhr.onreadystatechange = function () {
                        if (this.readyState === 4 && this.status === 200) {
                            var response = JSON.parse(this.responseText);
                            // Update the heart based on whether it's saved
                            if (response.is_saved) {
                                this.buttonElement.classList.add('active');
                            } else {
                                this.buttonElement.classList.remove('active');
                            }
                        }
                    };

                    // Send the request with course data
                    var requestData = JSON.stringify({
                        university: university,
                        course: course,
                        course_type: courseType,
                        duration: duration,
                        requirements: requirements,
                        course_link: courseLink
                    });
                    xhr.send(requestData);
                }
            {% endif %}
        }

        // Set up heart buttons when page loads
        document.addEventListener('DOMContentLoaded', setupHeartButtons);

        // Refresh heart states when user navigates back to page (no reload, just update hearts)
        window.addEventListener('pageshow', function (event) {
            if (event.persisted) {
                console.log('Page loaded from cache, refreshing heart states...');
                refreshHeartStates();
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Function to submit the correct form and close the dropdown
            function setupApplyButton(buttonId, formId, dropdownId) {
                var applyBtn = document.getElementById(buttonId);
                var dropdown = document.getElementById(dropdownId);
                var mainForm = document.getElementById(formId);

                if (applyBtn && mainForm) {
                    applyBtn.addEventListener('click', function () {
                        // This command correctly triggers the AJAX form submission
                        mainForm.requestSubmit();
                        if (dropdown) {
                            dropdown.style.display = 'none'; // Hide dropdown
                        }
                    });
                }
            }

            // Function to make checkboxes act like radio buttons (only one at a time)
            function setupCheckboxExclusivity(formId) {
                var form = document.getElementById(formId);
                if (!form) return;

                var onlyGrades = form.querySelector('input[name="only_grades"]');
                var noRequirements = form.querySelector('input[name="no_requirements"]');

                if (onlyGrades && noRequirements) {
                    onlyGrades.addEventListener('change', function () {
                        if (this.checked) {
                            noRequirements.checked = false;
                        }
                    });

                    noRequirements.addEventListener('change', function () {
                        if (this.checked) {
                            onlyGrades.checked = false;
                        }
                    });
                }
            }

            function monitorFilterState(dropdownId, buttonId) {
                var dropdown = document.getElementById(dropdownId);
                var button = document.getElementById(buttonId);

                if (!dropdown || !button) return;

                // Function to check if any filter is actually active
                function checkState() {
                    var isActive = false;

                    // Check all dropdowns
                    var selects = dropdown.querySelectorAll('select');
                    for (var i = 0; i < selects.length; i++) {
                        if (selects[i].value !== "") { // If it's not "Any"
                            isActive = true;
                        }
                    }

                    // Check all checkboxes
                    var checkboxes = dropdown.querySelectorAll('input[type="checkbox"]');
                    for (var i = 0; i < checkboxes.length; i++) {
                        if (checkboxes[i].checked) {
                            isActive = true;
                        }
                    }

                    // Toggle the class based on result
                    if (isActive) {
                        button.classList.add('active');
                    } else {
                        button.classList.remove('active');
                    }
                }

                // Run check immediately (in case browser cached values)
                checkState();

                // Run check whenever user changes something
                dropdown.addEventListener('change', checkState);
            }

            // Function to clear filters and submit
            function setupClearButton(clearBtnId, formId, dropdownId) {
                var clearBtn = document.getElementById(clearBtnId);
                var form = document.getElementById(formId);
                var dropdown = document.getElementById(dropdownId);

                if (clearBtn && form) {
                    clearBtn.addEventListener('click', function () {
                        // 1. Reset all Dropdowns to empty
                        var selects = dropdown.querySelectorAll('select');
                        for (var i = 0; i < selects.length; i++) {
                            selects[i].value = "";
                        }

                        // 2. Uncheck all Checkboxes
                        var checkboxes = dropdown.querySelectorAll('input[type="checkbox"]');
                        for (var i = 0; i < checkboxes.length; i++) {
                            checkboxes[i].checked = false;
                        }

                        // 3. Trigger the "Change" event so the blue button turns grey immediately
                        dropdown.dispatchEvent(new Event('change'));

                        // 4. Submit the form (to refresh results with no filters)
                        form.requestSubmit();

                        // 5. Close the dropdown
                        if (dropdown) dropdown.style.display = 'none';
                    });
                }
            }

            // Setup Clear Buttons
            setupClearButton('matches-clear-filters', 'matches-search-form', 'matches-filter-dropdown');
            setupClearButton('search-clear-filters', 'search-search-form', 'search-filter-dropdown');

            // Activate monitoring for both tabs
            monitorFilterState('matches-filter-dropdown', 'matches-filter-btn');
            monitorFilterState('search-filter-dropdown', 'search-filter-btn');

            setupCheckboxExclusivity('matches-search-form');
            setupCheckboxExclusivity('search-search-form');

            setupApplyButton('matches-apply-filters', 'matches-search-form', 'matches-filter-dropdown');
            setupApplyButton('search-apply-filters', 'search-search-form', 'search-filter-dropdown');
        });
    </script>


{% endblock %}