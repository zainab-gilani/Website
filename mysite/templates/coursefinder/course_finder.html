{% extends 'base.html' %}
{% load static %}

{% block content %}
    <link rel="stylesheet" href="{% static 'coursefinder/style.css' %}?v={% now 'U' %}">

    <h1>UniMatch</h1>

    <div class="tab-switcher">
        <div class="tab-btns">
            <button class="tab-btn active" id="matchesTabBtn">Matches</button>
            <button class="tab-btn" id="searchTabBtn">Uni Search</button>
            <div class="slider-bg" id="sliderBg" style="left:8px;"></div>
        </div>
    </div>

    <!-- MATCHES TAB -->
    <div id="matchesTabContent" class="tab-content" style="display:block;">
        <form method="POST" action="{% url 'coursefinder:coursefinder' %}?tab=matches" id="matches-search-form"
              autocomplete="off"
              class="search-form">
            {% csrf_token %}
            <div class="search-bar-wrapper"
                 style="display: flex; flex-direction: row; align-items: center; gap: 12px; position: relative; width: 100%;">
                <input type="text" name="query" id="matches-search" placeholder="Say Something..." autocomplete="off">

                <!-- FILTER BUTTONS -->
                <button type="button" id="matches-filter-btn" class="filter-btn" aria-label="Filter">
                    <img src="{% static 'images/filter.svg' %}" alt="Filter">
                </button>
                <div id="matches-filter-dropdown" class="filter-dropdown">
                    <form method="get" id="matches-filter-form" class="filter-form">
                        <!-- DROPDOWNS -->
                        <label class="filter-label">
                            Course Type
                            <select name="course_type" class="filter-select">
                                <option value="">Any</option>
                                {% for course_type in course_types %}
                                    <option value="{{ course_type }}"
                                            {% if request.GET.course_type == course_type %}selected{% endif %}>{{ course_type }}</option>
                                {% endfor %}
                            </select>
                        </label>

                        <label class="filter-label">
                            Duration
                            <select name="duration" class="filter-select">
                                <option value="">Any</option>
                                {% for duration in durations %}
                                    <option value="{{ duration }}"
                                            {% if request.GET.duration == duration %}selected{% endif %}>{{ duration }}</option>
                                {% endfor %}
                            </select>
                        </label>

                    <label class="filter-label">
                            Mode
                            <select name="course_type" class="filter-select">
                                <option value="">Any</option>
                                {% for mode in modes %}
                                    <option value="{{ mode }}"
                                            {% if request.GET.mode == mode %}selected{% endif %}>{{ mode }}</option>
                                {% endfor %}
                            </select>
                        </label>

                        <label class="filter-label">
                            Location
                            <select name="duration" class="filter-select">
                                <option value="">Any</option>
                                {% for location in locations %}
                                    <option value="{{ location }}"
                                            {% if request.GET.location == location %}selected{% endif %}>{{ location }}</option>
                                {% endfor %}
                            </select>
                        </label>

                        <!-- CHECKBOXES -->
                        <label class="filter-label" style="display: flex; align-items: center; gap: 6px;">
                            <input type="checkbox" name="only_grades"
                                   {% if request.GET.only_grades %}checked{% endif %}>
                            Show only grade-based requirements
                        </label>

                        <label class="filter-label" style="display: flex; align-items: center; gap: 6px;">
                            <input type="checkbox" name="no_requirements"
                                   {% if request.GET.no_requirements %}checked{% endif %}>
                            Show only courses with no requirements
                        </label>

                        <button type="submit" class="filter-submit">
                            Apply Filters
                        </button>
                    </form>
                </div>


                <div id="matches-search-tips" class="search-tips">
                    <div class="tips-title">Tips:</div>
                    <ul>
                        <li>"I have AAA in Maths, Physics, Chemistry"</li>
                        <li>"ABB in Biology, Chemistry, Maths"</li>
                        <li>"A in Maths, B in Physics, dropped Chemistry"</li>
                        <li>"Maths: A, Physics: B, Chemistry: C"</li>
                        <li>"I want to study Medicine"</li>
                        <li>"Looking to apply for Psychology"</li>
                    </ul>
                </div>
            </div>
        </form>

        <!-- AJAX Results Table -->
        <div id="results-table">
            {% if parsed_input %}
                <p style="text-align:center; margin-top:30px; font-size:1.3rem; font-weight:700; color:#2D5289FF;">
                    {{ parsed_input }}
                </p>
            {% endif %}
            {% include "coursefinder/_results_table.html" %}
        </div>
    </div>



    <!-- UNI SEARCH TAB -->
    <div id="searchTabContent" class="tab-content" style="display:none;">
        <form method="POST" action="{% url 'coursefinder:coursefinder' %}?tab=search" id="search-search-form"
              autocomplete="off"
              class="search-form">
            {% csrf_token %}
            <div class="search-bar-wrapper"
                 style="display: flex; flex-direction: row; align-items: center; gap: 12px; position: relative; width: 100%;">
                <input type="text" name="query" id="search-search" placeholder="Search" autocomplete="off">

                <!-- FILTER BUTTONS -->
                <button type="button" id="search-filter-btn" class="filter-btn" aria-label="Filter">
                    <img src="{% static 'images/filter.svg' %}" alt="Filter">
                </button>
                <div id="search-filter-dropdown" class="filter-dropdown">
                    <form method="get" id="search-filter-form" class="filter-form">
                        <!-- DROPDOWNS -->
                        <label class="filter-label">
                            Course Type
                            <select name="course_type" class="filter-select">
                                <option value="">Any</option>
                                {% for course_type in course_types %}
                                    <option value="{{ course_type }}"
                                            {% if request.GET.course_type == course_type %}selected{% endif %}>{{ course_type }}</option>
                                {% endfor %}
                            </select>
                        </label>

                        <label class="filter-label">
                            Duration
                            <select name="duration" class="filter-select">
                                <option value="">Any</option>
                                {% for duration in durations %}
                                    <option value="{{ duration }}"
                                            {% if request.GET.duration == duration %}selected{% endif %}>{{ duration }}</option>
                                {% endfor %}
                            </select>
                        </label>

                    <label class="filter-label">
                            Mode
                            <select name="course_type" class="filter-select">
                                <option value="">Any</option>
                                {% for mode in modes %}
                                    <option value="{{ mode }}"
                                            {% if request.GET.mode == mode %}selected{% endif %}>{{ mode }}</option>
                                {% endfor %}
                            </select>
                        </label>

                        <label class="filter-label">
                            Location
                            <select name="duration" class="filter-select">
                                <option value="">Any</option>
                                {% for location in locations %}
                                    <option value="{{ location }}"
                                            {% if request.GET.location == location %}selected{% endif %}>{{ location }}</option>
                                {% endfor %}
                            </select>
                        </label>

                        <!-- CHECKBOXES -->

                        <label class="filter-label" style="display: flex; align-items: center; gap: 6px;">
                            <input type="checkbox" name="only_grades"
                                   {% if request.GET.only_grades %}checked{% endif %}>
                            Show only grade-based requirements
                        </label>

                        <label class="filter-label" style="display: flex; align-items: center; gap: 6px;">
                            <input type="checkbox" name="no_requirements"
                                   {% if request.GET.no_requirements %}checked{% endif %}>
                            Show only courses with no requirements
                        </label>

                        <button type="submit" class="filter-submit">
                            Apply Filters
                        </button>
                    </form>
                </div>
            </div>
        </form>
    </div>
    <div id="search-search-tips" class="search-tips">
        <div class="tips-title">Examples:</div>
        <ul>
            <li>"University of Manchester"</li>
            <li>"London"</li>
            <li>"Best unis for Law"</li>
            <li>"Medicine"</li>
        </ul>
    </div>

    <!-- AJAX Results for Uni Search -->
    <div id="search-results-table">
        {% if mode == 'search' %}
            {% if parsed_input %}
                <p style="text-align:center; margin-top:30px; font-size:1.3rem; font-weight:700; color:#2D5289FF;">
                    {{ parsed_input }}
                </p>
            {% endif %}
            {% include "coursefinder/_results_table.html" %}
        {% endif %}
    </div>

    <!-- USER AUTH (PROFILE DROPDOWN ETC) -->
    {% if user.is_authenticated %}
        <div class="profile-dropdown">
            <img src="{% static 'images/pfp.svg' %}" alt="pfp" class="pfp-small">
            <div class="dropdown-content">
                <a href="{% url 'accounts:profile' %}" class="dropdown-link">
                    <img src="{% static 'images/profile.svg' %}" alt="" class="icon">
                    <span>Profile</span>
                </a>
                <hr>
                <form action="{% url 'accounts:logout' %}?next={% url 'coursefinder:guest_coursefinder' %}"
                      method="post" style="margin:0;padding:0;">
                    {% csrf_token %}
                    <button type="submit" class="dropdown-link" style="background:none;border:none;">
                        <img src="{% static 'images/logout.svg' %}" alt="" class="icon">
                        <span>Logout</span>
                    </button>
                </form>
            </div>
        </div>
        <a href="{% url 'accounts:saved_matches' %}" class="saved-btn">Saved<br>Matches</a>
    {% else %}
        <div class="guest-options">
            <a href="{% url 'accounts:login' %}" class="button">SIGN IN</a>
        </div>
    {% endif %}

    <div class="rotating-text">
        <span id="text"></span>
        <span id="highlight"></span>
    </div>

    <script>
        // Set up filter dropdown for matches tab
        function setupMatchesFilter() {
            var matchesFilterBtn = document.getElementById('matches-filter-btn');
            var matchesFilterDropdown = document.getElementById('matches-filter-dropdown');

            if (matchesFilterBtn && matchesFilterDropdown) {
                matchesFilterBtn.onclick = function (e) {
                    e.stopPropagation();
                    matchesFilterDropdown.style.display = (matchesFilterDropdown.style.display === 'block') ? 'none' : 'block';
                };

                // Close dropdown when clicking outside
                document.addEventListener('click', function (e) {
                    if (matchesFilterDropdown.style.display === 'block' && !matchesFilterDropdown.contains(e.target) && e.target !== matchesFilterBtn) {
                        matchesFilterDropdown.style.display = 'none';
                    }
                });
            }
        }

        // Set up filter dropdown for search tab  
        function setupSearchFilter() {
            var searchFilterBtn = document.getElementById('search-filter-btn');
            var searchFilterDropdown = document.getElementById('search-filter-dropdown');

            console.log('Setting up search filter...');
            console.log('Search filter button found:', searchFilterBtn ? 'YES' : 'NO');
            console.log('Search filter dropdown found:', searchFilterDropdown ? 'YES' : 'NO');

            if (searchFilterBtn && searchFilterDropdown) {
                searchFilterBtn.onclick = function (e) {
                    e.stopPropagation();
                    console.log('Search filter clicked!');
                    searchFilterDropdown.style.display = (searchFilterDropdown.style.display === 'block') ? 'none' : 'block';
                };

                // Close dropdown when clicking outside
                document.addEventListener('click', function (e) {
                    if (searchFilterDropdown.style.display === 'block' && !searchFilterDropdown.contains(e.target) && e.target !== searchFilterBtn) {
                        searchFilterDropdown.style.display = 'none';
                    }
                });

                console.log('Search filter setup complete');
            } else {
                console.log('Could not set up search filter - missing elements');
            }
        }

        // Set up filters on page load
        document.addEventListener('DOMContentLoaded', function () {
            setupMatchesFilter();
            setupSearchFilter();
        });
    </script>


    <script>
        // Handle tips popups for both forms
        function setupTips(inputId, tipsId, formId) {
            const input = document.getElementById(inputId);
            const tipsBox = document.getElementById(tipsId);
            if (!input || !tipsBox) return;
            input.addEventListener('focus', function () {
                tipsBox.style.opacity = '1';
                tipsBox.style.pointerEvents = 'auto';
            });
            input.addEventListener('blur', function () {
                setTimeout(() => {
                    tipsBox.style.opacity = '0';
                    tipsBox.style.pointerEvents = 'none';
                }, 120);
            });
            document.getElementById(formId).addEventListener('submit', function () {
                tipsBox.style.opacity = '0';
                tipsBox.style.pointerEvents = 'none';
            });
        }

        window.addEventListener('DOMContentLoaded', function () {
            setupTips('matches-search', 'matches-search-tips', 'matches-search-form');
            setupTips('search-search', 'search-search-tips', 'search-search-form');
            // Hide all tips by default
            let allTips = document.querySelectorAll('.search-tips');
            allTips.forEach(t => {
                t.style.opacity = '0';
                t.style.pointerEvents = 'none';
            });
        });

        // Rotating Text
        const phrases = [
            "Find your perfect university course in seconds.",
            "Compare degrees from top UK universities.",
            "Personalised matches—no stress, no hassle.",
            "Struggling to choose? Let UniMatch help you decide.",
            "Discover courses tailored to your interests.",
            "No ads, no nonsense. Just pure course search.",
            "Track your favourites and save your shortlist.",
            "Access exclusive tips for your university application.",
            "Wanna go Russell Group? We’ll show you the way.",
            "Browse entry requirements, deadlines, and more.",
            "Your degree. Your future. Sorted.",
            "UniMatch: Your shortcut to the perfect uni.",
            "Curious about grades? See what you need—instantly.",
            "Courses for every vibe, every dream.",
            "Start your journey. Find your match today.",
        ];
        let index = 1;
        const textElement = document.getElementById("text");
        const highlightElement = document.getElementById("highlight");
        highlightElement.style.backgroundColor = "#878787";

        function showHighlight() {
            highlightElement.style.width = 200;
        }

        function rotateText() {
            textElement.style.opacity = 0;
            setTimeout(() => {
                textElement.textContent = phrases[index];
                textElement.style.opacity = 1;
                index = (index + 1) % phrases.length;
            }, 500);
        }

        textElement.textContent = phrases[0];
        setInterval(showHighlight, 1000);
        setInterval(rotateText, 4000);

        // Tabs Switcher (with fade for smoothness)
        const matchesTabBtn = document.getElementById('matchesTabBtn');
        const searchTabBtn = document.getElementById('searchTabBtn');
        const matchesTabContent = document.getElementById('matchesTabContent');
        const searchTabContent = document.getElementById('searchTabContent');
        const sliderBg = document.getElementById('sliderBg');

        function showTab(tab) {
            if (tab === 'matches') {
                matchesTabBtn.classList.add('active');
                searchTabBtn.classList.remove('active');
                sliderBg.style.left = '8px';
                matchesTabContent.style.opacity = 0;
                searchTabContent.style.opacity = 0;
                setTimeout(() => {
                    matchesTabContent.style.display = 'block';
                    searchTabContent.style.display = 'none';
                    setTimeout(() => {
                        matchesTabContent.style.opacity = 1;
                    }, 30);
                }, 120);
            } else {
                searchTabBtn.classList.add('active');
                matchesTabBtn.classList.remove('active');
                sliderBg.style.left = '164px';
                matchesTabContent.style.opacity = 0;
                searchTabContent.style.opacity = 0;
                setTimeout(() => {
                    searchTabContent.style.display = 'block';
                    matchesTabContent.style.display = 'none';
                    setTimeout(() => {
                        searchTabContent.style.opacity = 1;
                    }, 30);
                }, 120);
            }
            setTimeout(function () {
                setupMatchesFilter();
                setupSearchFilter();
            }, 140);
        }

        matchesTabBtn.addEventListener('click', () => showTab('matches'));
        searchTabBtn.addEventListener('click', () => showTab('search'));

        // CSS transition for tab-content
        document.head.insertAdjacentHTML("beforeend", `
<style>
.tab-content { transition: opacity .18s; opacity: 1;}
</style>
`);
    </script>

    <script>
        window.addEventListener('DOMContentLoaded', function () {
            // Django passes mode as {{ mode|escapejs }}
            const mode = "{{ mode|escapejs }}";
            if (mode === 'search') {
                showTab('search');
            } else {
                showTab('matches');
            }
        });

    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Handle matches form (NLP parser)
            var matchesForm = document.getElementById("matches-search-form");
            if (matchesForm) {
                matchesForm.onsubmit = function (e) {
                    e.preventDefault();
                    
                    // Get the form data
                    var formData = new FormData(matchesForm);
                    
                    // Create simple AJAX request
                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', matchesForm.action, true);
                    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                    
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState === 4 && xhr.status === 200) {
                            var response = JSON.parse(xhr.responseText);
                            document.getElementById("results-table").innerHTML = response.table_html;
                            // Set up heart buttons after loading new content
                            setupHeartButtons();
                        }
                    };
                    
                    xhr.send(formData);
                };
            }

            // Handle search form (general university search)
            var searchForm = document.getElementById("search-search-form");
            if (searchForm) {
                searchForm.onsubmit = function (e) {
                    e.preventDefault();
                    
                    // Get the form data
                    var formData = new FormData(searchForm);
                    
                    // Create simple AJAX request
                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', searchForm.action, true);
                    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                    
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState === 4 && xhr.status === 200) {
                            var response = JSON.parse(xhr.responseText);
                            
                            // Find or create results div
                            var resultsDiv = document.getElementById("search-results-table");
                            if (!resultsDiv) {
                                resultsDiv = document.createElement("div");
                                resultsDiv.id = "search-results-table";
                                document.getElementById("searchTabContent").appendChild(resultsDiv);
                            }
                            resultsDiv.innerHTML = response.table_html;
                            // Set up heart buttons after loading new content
                            setupHeartButtons();
                        }
                    };
                    
                    xhr.send(formData);
                };
            }
        });

        // Function to set up heart button functionality
        function setupHeartButtons() {
            {% if user.is_authenticated %}
                console.log('Setting up heart buttons...');
                var heartBtns = document.querySelectorAll('.heart-btn');
                console.log('Found heart buttons:', heartBtns.length);

                // Add click event to each heart button
                for (var i = 0; i < heartBtns.length; i++) {
                    var btn = heartBtns[i];
                    btn.onclick = function () {
                        var isCurrentlySaved = this.classList.contains('active');
                        console.log('Heart button clicked! Currently saved:', isCurrentlySaved);

                        // Toggle the active class to change appearance
                        if (isCurrentlySaved) {
                            this.classList.remove('active');
                        } else {
                            this.classList.add('active');
                        }

                        // Get all the course info from the button
                        var university = this.getAttribute('data-university');
                        var course = this.getAttribute('data-course');
                        var courseType = this.getAttribute('data-course_type');
                        var duration = this.getAttribute('data-duration');
                        var requirements = this.getAttribute('data-requirements');
                        var courseLink = this.getAttribute('data-course_link');

                        // Choose the right URL - save or unsave
                        var requestUrl;
                        if (isCurrentlySaved) {
                            requestUrl = "{% url 'accounts:unsave_match' %}";
                        } else {
                            requestUrl = "{% url 'accounts:save_match' %}";
                        }

                        // Create the request data
                        var requestData = JSON.stringify({
                            university: university,
                            course: course,
                            course_type: courseType,
                            duration: duration,
                            requirements: requirements,
                            course_link: courseLink
                        });

                        // Send the request using simple XMLHttpRequest
                        var xhr = new XMLHttpRequest();
                        xhr.open('POST', requestUrl, true);
                        xhr.setRequestHeader('Content-Type', 'application/json');
                        xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
                        
                        var currentButton = this;
                        xhr.onreadystatechange = function() {
                            if (xhr.readyState === 4) {
                                if (xhr.status === 200) {
                                    console.log('Save/unsave successful');
                                } else {
                                    console.log('Save failed with status:', xhr.status);
                                    // Put the button back to original state if save failed
                                    if (isCurrentlySaved) {
                                        currentButton.classList.add('active');
                                    } else {
                                        currentButton.classList.remove('active');
                                    }
                                }
                            }
                        };
                        
                        xhr.send(requestData);
                    };
                }
            {% else %}
                console.log('User is NOT authenticated - no heart buttons');
            {% endif %}
        }

        // Cookie helper function
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Set up heart buttons when page loads
        document.addEventListener('DOMContentLoaded', setupHeartButtons);
    </script>


{% endblock %}