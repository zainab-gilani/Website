{% extends 'base.html' %}
{% load static %}

{% block content %}
    <link rel="stylesheet" href="{% static 'coursefinder/style.css' %}?v={% now 'U' %}">

    <h1>UniMatch</h1>

    <div class="tab-switcher">
        <div class="tab-btns">
            <button class="tab-btn active" id="matchesTabBtn">Matches</button>
            <button class="tab-btn" id="searchTabBtn">Uni Search</button>
            <div class="slider-bg" id="sliderBg" style="left:8px;"></div>
        </div>
    </div>

    <!-- MATCHES TAB -->
    <div id="matchesTabContent" class="tab-content" style="display:block;">
        <form method="POST" action="{% url 'coursefinder:coursefinder' %}?tab=matches" id="matches-search-form"
              autocomplete="off"
              class="search-form">
            {% csrf_token %}
            <div class="search-bar-wrapper">
                <input type="text" name="query" id="matches-search" placeholder="Say Something..." autocomplete="off">
                <div id="matches-search-tips" class="search-tips">
                    <div class="tips-title">Tips:</div>
                    <ul>
                        <li>"I have AAA in Maths, Physics, Chemistry"</li>
                        <li>"ABB in Biology, Chemistry, Maths"</li>
                        <li>"A in Maths, B in Physics, dropped Chemistry"</li>
                        <li>"Maths: A, Physics: B, Chemistry: C"</li>
                        <li>"I want to study Medicine"</li>
                        <li>"Looking to apply for Psychology"</li>
                    </ul>
                </div>
            </div>
        </form>

        <!-- AJAX Results Table -->
        <div id="results-table">
            {% if parsed_input %}
                <p style="text-align:center; margin-top:30px; font-size:1.3rem; font-weight:700; color:#2D5289FF;">
                    {{ parsed_input }}
                </p>
            {% endif %}
            {% include "coursefinder/_results_table.html" %}
        </div>
    </div>



    <!-- UNI SEARCH TAB -->
    <div id="searchTabContent" class="tab-content" style="display:none;">
        <form method="POST" action="{% url 'coursefinder:coursefinder' %}?tab=search" id="search-search-form"
              autocomplete="off"
              class="search-form">
            {% csrf_token %}
            <div class="search-bar-wrapper">
                <input type="text" name="query" id="search-search" placeholder="Search" autocomplete="off">
                <div id="search-search-tips" class="search-tips">
                    <div class="tips-title">Examples:</div>
                    <ul>
                        <li>"University of Manchester"</li>
                        <li>"London"</li>
                        <li>"Best unis for Law"</li>
                        <li>"Medicine"</li>
                    </ul>
                </div>
            </div>
        </form>
        
        <!-- AJAX Results for Uni Search -->
        <div id="search-results-table">
            {% if mode == 'search' %}
                {% if parsed_input %}
                    <p style="text-align:center; margin-top:30px; font-size:1.3rem; font-weight:700; color:#2D5289FF;">
                        {{ parsed_input }}
                    </p>
                {% endif %}
                {% include "coursefinder/_results_table.html" %}
            {% endif %}
        </div>
    </div>

    <!-- USER AUTH (PROFILE DROPDOWN ETC) -->
    {% if user.is_authenticated %}
        <div class="profile-dropdown">
            <img src="{% static 'images/pfp.svg' %}" alt="pfp" class="pfp-small">
            <div class="dropdown-content">
                <a href="{% url 'accounts:profile' %}" class="dropdown-link">
                    <img src="{% static 'images/profile.svg' %}" alt="" class="icon">
                    <span>Profile</span>
                </a>
                <hr>
                <form action="{% url 'accounts:logout' %}?next={% url 'coursefinder:guest_coursefinder' %}"
                      method="post" style="margin:0;padding:0;">
                    {% csrf_token %}
                    <button type="submit" class="dropdown-link" style="background:none;border:none;">
                        <img src="{% static 'images/logout.svg' %}" alt="" class="icon">
                        <span>Logout</span>
                    </button>
                </form>
            </div>
        </div>
        <a href="{% url 'accounts:saved_matches' %}" class="saved-btn">Saved<br>Matches</a>
    {% else %}
        <div class="guest-options">
            <a href="{% url 'accounts:login' %}" class="button">SIGN IN</a>
        </div>
    {% endif %}

    <div class="rotating-text">
        <span id="text"></span>
        <span id="highlight"></span>
    </div>

    <script>
        // Handle tips popups for both forms
        function setupTips(inputId, tipsId, formId) {
            const input = document.getElementById(inputId);
            const tipsBox = document.getElementById(tipsId);
            if (!input || !tipsBox) return;
            input.addEventListener('focus', function () {
                tipsBox.style.opacity = '1';
                tipsBox.style.pointerEvents = 'auto';
            });
            input.addEventListener('blur', function () {
                setTimeout(() => {
                    tipsBox.style.opacity = '0';
                    tipsBox.style.pointerEvents = 'none';
                }, 120);
            });
            document.getElementById(formId).addEventListener('submit', function () {
                tipsBox.style.opacity = '0';
                tipsBox.style.pointerEvents = 'none';
            });
        }

        window.addEventListener('DOMContentLoaded', function () {
            setupTips('matches-search', 'matches-search-tips', 'matches-search-form');
            setupTips('search-search', 'search-search-tips', 'search-search-form');
            // Hide all tips by default
            let allTips = document.querySelectorAll('.search-tips');
            allTips.forEach(t => {
                t.style.opacity = '0';
                t.style.pointerEvents = 'none';
            });
        });

        // Rotating Text
        const phrases = [
            "Find your perfect university course in seconds.",
            "Compare degrees from top UK universities.",
            "Personalised matches—no stress, no hassle.",
            "Struggling to choose? Let UniMatch help you decide.",
            "Discover courses tailored to your interests.",
            "No ads, no nonsense. Just pure course search.",
            "Track your favourites and save your shortlist.",
            "Access exclusive tips for your university application.",
            "Wanna go Russell Group? We’ll show you the way.",
            "Browse entry requirements, deadlines, and more.",
            "Your degree. Your future. Sorted.",
            "UniMatch: Your shortcut to the perfect uni.",
            "Curious about grades? See what you need—instantly.",
            "Courses for every vibe, every dream.",
            "Start your journey. Find your match today.",
        ];
        let index = 1;
        const textElement = document.getElementById("text");
        const highlightElement = document.getElementById("highlight");
        highlightElement.style.backgroundColor = "#878787";

        function showHighlight() {
            highlightElement.style.width = 200;
        }

        function rotateText() {
            textElement.style.opacity = 0;
            setTimeout(() => {
                textElement.textContent = phrases[index];
                textElement.style.opacity = 1;
                index = (index + 1) % phrases.length;
            }, 500);
        }

        textElement.textContent = phrases[0];
        setInterval(showHighlight, 1000);
        setInterval(rotateText, 4000);

        // Tabs Switcher (with fade for smoothness)
        const matchesTabBtn = document.getElementById('matchesTabBtn');
        const searchTabBtn = document.getElementById('searchTabBtn');
        const matchesTabContent = document.getElementById('matchesTabContent');
        const searchTabContent = document.getElementById('searchTabContent');
        const sliderBg = document.getElementById('sliderBg');

        function showTab(tab) {
            if (tab === 'matches') {
                matchesTabBtn.classList.add('active');
                searchTabBtn.classList.remove('active');
                sliderBg.style.left = '8px';
                matchesTabContent.style.opacity = 0;
                searchTabContent.style.opacity = 0;
                setTimeout(() => {
                    matchesTabContent.style.display = 'block';
                    searchTabContent.style.display = 'none';
                    setTimeout(() => {
                        matchesTabContent.style.opacity = 1;
                    }, 30);
                }, 120);
            } else {
                searchTabBtn.classList.add('active');
                matchesTabBtn.classList.remove('active');
                sliderBg.style.left = '164px';
                matchesTabContent.style.opacity = 0;
                searchTabContent.style.opacity = 0;
                setTimeout(() => {
                    searchTabContent.style.display = 'block';
                    matchesTabContent.style.display = 'none';
                    setTimeout(() => {
                        searchTabContent.style.opacity = 1;
                    }, 30);
                }, 120);
            }
        }

        matchesTabBtn.addEventListener('click', () => showTab('matches'));
        searchTabBtn.addEventListener('click', () => showTab('search'));

        // CSS transition for tab-content
        document.head.insertAdjacentHTML("beforeend", `
<style>
.tab-content { transition: opacity .18s; opacity: 1;}
</style>
`);
    </script>

    <script>
        window.addEventListener('DOMContentLoaded', function () {
            // Django passes mode as {{ mode|escapejs }}
            const mode = "{{ mode|escapejs }}";
            if (mode === 'search') {
                showTab('search');
            } else {
                showTab('matches');
            }
        });

    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Handle matches form (NLP parser)
            const matchesForm = document.getElementById("matches-search-form");
            if (matchesForm) {
                matchesForm.addEventListener("submit", function (e) {
                    e.preventDefault();
                    const formData = new FormData(matchesForm);
                    fetch(matchesForm.action, {
                        method: "POST",
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                        },
                        body: formData,
                    })
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById("results-table").innerHTML = data.table_html;
                            // Set up heart buttons after loading new content
                            setupHeartButtons();
                        });
                });
            }
            
            // Handle search form (general university search)
            const searchForm = document.getElementById("search-search-form");
            if (searchForm) {
                searchForm.addEventListener("submit", function (e) {
                    e.preventDefault();
                    const formData = new FormData(searchForm);
                    fetch(searchForm.action, {
                        method: "POST",
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                        },
                        body: formData,
                    })
                        .then(response => response.json())
                        .then(data => {
                            // Create results div if not exists
                            let resultsDiv = document.getElementById("search-results-table");
                            if (!resultsDiv) {
                                resultsDiv = document.createElement("div");
                                resultsDiv.id = "search-results-table";
                                document.getElementById("searchTabContent").appendChild(resultsDiv);
                            }
                            resultsDiv.innerHTML = data.table_html;
                            // Set up heart buttons after loading new content
                            setupHeartButtons();
                        });
                });
            }
        });
        
        // Function to set up heart button functionality
        function setupHeartButtons() {
            {% if user.is_authenticated %}
            console.log('Setting up heart buttons...');
            var heartBtns = document.querySelectorAll('.heart-btn');
            console.log('Found heart buttons:', heartBtns.length);
            
            // Add click event to each heart button
            for (var i = 0; i < heartBtns.length; i++) {
                var btn = heartBtns[i];
                btn.addEventListener('click', function() {
                    var isCurrentlySaved = this.classList.contains('active');
                    console.log('Heart button clicked! Currently saved:', isCurrentlySaved);
                    
                    // Simple test first - just toggle the active class
                    this.classList.toggle('active');
                    console.log('Toggled to:', this.classList.contains('active'));
                    console.log('Button classes:', this.className);
                    
                    // Get all the course info from the button
                    var courseData = {
                        university: this.getAttribute('data-university'),
                        course: this.getAttribute('data-course'),
                        course_type: this.getAttribute('data-course_type'),
                        duration: this.getAttribute('data-duration'),
                        requirements: this.getAttribute('data-requirements'),
                        course_link: this.getAttribute('data-course_link')
                    };
                    
                    // Choose the right URL - save or unsave
                    var saveUrl = "{% url 'accounts:save_match' %}";
                    var unsaveUrl = "{% url 'accounts:unsave_match' %}";
                    var requestUrl = isCurrentlySaved ? unsaveUrl : saveUrl;
                    
                    // Get the security token
                    var csrfToken = getCookie('csrftoken');
                    console.log('Sending request to:', requestUrl);
                    
                    // Send the request to save or unsave
                    fetch(requestUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify(courseData)
                    }).then(function(response) {
                        if (response.ok) {
                            console.log('Save/unsave successful');
                        } else {
                            console.log('Save failed with status:', response.status);
                            // Revert the toggle if save failed
                            btn.classList.toggle('active');
                        }
                    }).catch(function(error) {
                        console.log('Request failed:', error);
                        // Revert the toggle if request failed
                        btn.classList.toggle('active');
                    });
                });
            }
            {% else %}
            console.log('User is NOT authenticated - no heart buttons');
            {% endif %}
        }
        
        // Cookie helper function
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Set up heart buttons on initial page load
        document.addEventListener('DOMContentLoaded', setupHeartButtons);
        
        // Update heart states when page becomes visible again (like when using back button)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Page is now visible, refresh heart states
                refreshHeartStates();
            }
        });
        
        // Function to refresh heart states from server
        function refreshHeartStates() {
            {% if user.is_authenticated %}
            // Get all current hearts on the page
            var heartBtns = document.querySelectorAll('.heart-btn');
            
            // Check each heart to see if it should be saved
            for (var i = 0; i < heartBtns.length; i++) {
                var btn = heartBtns[i];
                var courseData = {
                    university: btn.getAttribute('data-university'),
                    course: btn.getAttribute('data-course'),
                    course_type: btn.getAttribute('data-course_type'),
                    duration: btn.getAttribute('data-duration'),
                    requirements: btn.getAttribute('data-requirements'),
                    course_link: btn.getAttribute('data-course_link')
                };
                
                // Check if this course is saved
                checkIfSaved(btn, courseData);
            }
            {% endif %}
        }
        
        // Function to check if a specific course is saved
        function checkIfSaved(btn, courseData) {
            var csrfToken = getCookie('csrftoken');
            
            fetch("{% url 'accounts:check_saved' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(courseData)
            }).then(function(response) {
                return response.json();
            }).then(function(data) {
                // Update the heart based on server response
                if (data.is_saved) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }).catch(function(error) {
                // If check fails, just leave the heart as it is
                console.log('Could not check saved status:', error);
            });
        }
    </script>


{% endblock %}