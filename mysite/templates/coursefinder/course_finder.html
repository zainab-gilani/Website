{% extends 'base.html' %}
{% load static %}

{% block content %}
    <link rel="stylesheet" href="{% static 'coursefinder/style.css' %}">

    <h1>UniMatch</h1>

    <div class="tab-switcher">
        <div class="tab-btns">
            <button class="tab-btn active" id="matchesTabBtn">Matches</button>
            <button class="tab-btn" id="searchTabBtn">Uni Search</button>
            <div class="slider-bg" id="sliderBg" style="left:8px;"></div>
        </div>
    </div>

    <!-- MATCHES TAB -->
    <div id="matchesTabContent" class="tab-content" style="display:block;">
        <form method="POST" action="{% url 'coursefinder:coursefinder' %}?tab=matches" id="matches-search-form"
              autocomplete="off"
              class="search-form">
            {% csrf_token %}
            <div class="search-bar-wrapper">
                <input type="text" name="query" id="matches-search" placeholder="Say Something..." autocomplete="off">
                <div id="matches-search-tips" class="search-tips">
                    <div class="tips-title">Tips:</div>
                    <ul>
                        <li>"I have AAA in Maths, Physics, Chemistry"</li>
                        <li>"ABB in Biology, Chemistry, Maths"</li>
                        <li>"A in Maths, B in Physics, dropped Chemistry"</li>
                        <li>"Maths: A, Physics: B, Chemistry: C"</li>
                        <li>"I want to study Medicine"</li>
                        <li>"Looking to apply for Psychology"</li>
                    </ul>
                </div>
            </div>
        </form>

        <!-- AJAX Results Table -->
        <div id="results-table">
            {% if parsed_input %}
                <p style="text-align:center; margin-top:30px; font-size:1.3rem; font-weight:700; color:#2D5289FF;">
                    {{ parsed_input }}
                </p>
            {% endif %}
            {% include "coursefinder/_results_table.html" %}
        </div>
    </div>



    <!-- UNI SEARCH TAB -->
    <div id="searchTabContent" class="tab-content" style="display:none;">
        <form method="POST" action="{% url 'coursefinder:coursefinder' %}?tab=search" id="search-search-form"
              autocomplete="off"
              class="search-form">
            {% csrf_token %}
            <div class="search-bar-wrapper">
                <input type="text" name="query" id="search-search" placeholder="Search" autocomplete="off">
                <div id="search-search-tips" class="search-tips">
                    <div class="tips-title">Examples:</div>
                    <ul>
                        <li>"University of Manchester"</li>
                        <li>"London"</li>
                        <li>"How to write a personal statement"</li>
                        <li>"Best unis for Law"</li>
                    </ul>
                </div>
            </div>
        </form>
        {% if query %}
            <div style="text-align:center; margin-top:40px;">
                <h3>Results for "{{ query }}"</h3>
                <p>Here you would show resources/articles/tips for the searched query.</p>
            </div>
        {% endif %}
    </div>

    <!-- USER AUTH (PROFILE DROPDOWN ETC) -->
    {% if user.is_authenticated %}
        <div class="profile-dropdown">
            <img src="{% static 'images/pfp.svg' %}" alt="pfp" class="pfp-small">
            <div class="dropdown-content">
                <a href="{% url 'accounts:profile' %}" class="dropdown-link">
                    <img src="{% static 'images/profile.svg' %}" alt="" class="icon">
                    <span>Profile</span>
                </a>
                <hr>
                <form action="{% url 'accounts:logout' %}?next={% url 'coursefinder:guest_coursefinder' %}"
                      method="post" style="margin:0;padding:0;">
                    {% csrf_token %}
                    <button type="submit" class="dropdown-link" style="background:none;border:none;">
                        <img src="{% static 'images/logout.svg' %}" alt="" class="icon">
                        <span>Logout</span>
                    </button>
                </form>
            </div>
        </div>
        <a href="{% url 'accounts:saved_matches' %}" class="saved-btn">Saved<br>Matches</a>
    {% else %}
        <div class="guest-options">
            <a href="{% url 'accounts:login' %}" class="button">SIGN IN</a>
        </div>
    {% endif %}

    <div class="rotating-text">
        <span id="text"></span>
        <span id="highlight"></span>
    </div>

    <script>
        // Handle tips popups for both forms
        function setupTips(inputId, tipsId, formId) {
            const input = document.getElementById(inputId);
            const tipsBox = document.getElementById(tipsId);
            if (!input || !tipsBox) return;
            input.addEventListener('focus', function () {
                tipsBox.style.opacity = '1';
                tipsBox.style.pointerEvents = 'auto';
            });
            input.addEventListener('blur', function () {
                setTimeout(() => {
                    tipsBox.style.opacity = '0';
                    tipsBox.style.pointerEvents = 'none';
                }, 120);
            });
            document.getElementById(formId).addEventListener('submit', function () {
                tipsBox.style.opacity = '0';
                tipsBox.style.pointerEvents = 'none';
            });
        }

        window.addEventListener('DOMContentLoaded', function () {
            setupTips('matches-search', 'matches-search-tips', 'matches-search-form');
            setupTips('search-search', 'search-search-tips', 'search-search-form');
            // Hide all tips by default
            let allTips = document.querySelectorAll('.search-tips');
            allTips.forEach(t => {
                t.style.opacity = '0';
                t.style.pointerEvents = 'none';
            });
        });

        // Rotating Text
        const phrases = [
            "Find your perfect university course in seconds.",
            "Compare degrees from top UK universities.",
            "Personalised matches—no stress, no hassle.",
            "Struggling to choose? Let UniMatch help you decide.",
            "Discover courses tailored to your interests.",
            "No ads, no nonsense. Just pure course search.",
            "Track your favourites and save your shortlist.",
            "Access exclusive tips for your university application.",
            "Wanna go Russell Group? We’ll show you the way.",
            "Browse entry requirements, deadlines, and more.",
            "Your degree. Your future. Sorted.",
            "UniMatch: Your shortcut to the perfect uni.",
            "Curious about grades? See what you need—instantly.",
            "Courses for every vibe, every dream.",
            "Start your journey. Find your match today.",
        ];
        let index = 1;
        const textElement = document.getElementById("text");
        const highlightElement = document.getElementById("highlight");
        highlightElement.style.backgroundColor = "#878787";

        function showHighlight() {
            highlightElement.style.width = 200;
        }

        function rotateText() {
            textElement.style.opacity = 0;
            setTimeout(() => {
                textElement.textContent = phrases[index];
                textElement.style.opacity = 1;
                index = (index + 1) % phrases.length;
            }, 500);
        }

        textElement.textContent = phrases[0];
        setInterval(showHighlight, 1000);
        setInterval(rotateText, 4000);

        // Tabs Switcher (with fade for smoothness)
        const matchesTabBtn = document.getElementById('matchesTabBtn');
        const searchTabBtn = document.getElementById('searchTabBtn');
        const matchesTabContent = document.getElementById('matchesTabContent');
        const searchTabContent = document.getElementById('searchTabContent');
        const sliderBg = document.getElementById('sliderBg');

        function showTab(tab) {
            if (tab === 'matches') {
                matchesTabBtn.classList.add('active');
                searchTabBtn.classList.remove('active');
                sliderBg.style.left = '8px';
                matchesTabContent.style.opacity = 0;
                searchTabContent.style.opacity = 0;
                setTimeout(() => {
                    matchesTabContent.style.display = 'block';
                    searchTabContent.style.display = 'none';
                    setTimeout(() => {
                        matchesTabContent.style.opacity = 1;
                    }, 30);
                }, 120);
            } else {
                searchTabBtn.classList.add('active');
                matchesTabBtn.classList.remove('active');
                sliderBg.style.left = '164px';
                matchesTabContent.style.opacity = 0;
                searchTabContent.style.opacity = 0;
                setTimeout(() => {
                    searchTabContent.style.display = 'block';
                    matchesTabContent.style.display = 'none';
                    setTimeout(() => {
                        searchTabContent.style.opacity = 1;
                    }, 30);
                }, 120);
            }
        }

        matchesTabBtn.addEventListener('click', () => showTab('matches'));
        searchTabBtn.addEventListener('click', () => showTab('search'));

        // CSS transition for tab-content
        document.head.insertAdjacentHTML("beforeend", `
<style>
.tab-content { transition: opacity .18s; opacity: 1;}
</style>
`);
    </script>

    <script>
        window.addEventListener('DOMContentLoaded', function () {
            // Django passes mode as {{ mode|escapejs }}
            const mode = "{{ mode|escapejs }}";
            if (mode === 'search') {
                showTab('search');
            } else {
                showTab('matches');
            }
        });

    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.getElementById("matches-search-form");
            if (form) {
                form.addEventListener("submit", function (e) {
                    e.preventDefault();
                    const formData = new FormData(form);
                    fetch(form.action, {
                        method: "POST",
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                        },
                        body: formData,
                    })
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById("results-table").innerHTML = data.table_html;
                        });
                });
            }
        });
    </script>


{% endblock %}